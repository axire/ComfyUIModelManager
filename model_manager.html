<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ComfyUI Model Manager</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
            font-size: 14px;
        }
        
        h1 { color: #569cd6; border-bottom: 1px solid #4a4a4a; padding-bottom: 10px; }
        h2 { color: #9cdcfe; }
        h3 { color: #dcdcaa; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            background: #2a2a2a; 
            border-radius: 8px; 
            border: 1px solid #4a4a4a;
        }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        button { 
            background: #0e639c; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
            font-size: 13px;
        }
        button:hover { background: #1177bb; }
        button.danger { background: #d32f2f; color: white; }
        button.danger:hover { background: #f44336; }
        button.success { background: #388e3c; color: white; }
        button.success:hover { background: #4caf50; }
        
        input, textarea, select { 
            background: #3a3a3a; 
            color: #d4d4d4; 
            border: 1px solid #555; 
            padding: 8px; 
            border-radius: 4px; 
            width: 100%;
            box-sizing: border-box;
            margin: 5px 0;
        }
        
        .inline-edit {
            border: none;
            background: transparent;
            color: #d4d4d4;
            width: 100%;
            padding: 2px 5px;
        }
        .inline-edit:focus {
            background: #3a3a3a;
            border: 1px solid #569cd6;
        }
        
        .folder-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 5px;
            margin: 5px 0;
            font-size: 11px;
        }
        .folder-stat {
            background: #3a3a3a;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
            color: white;
            font-weight: 500;
        }
        .folder-stat.has-files {
            background: #2d5a2d;
            color: white;
        }
        
        .status-area {
            background: #2a2a2a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            padding: 5px;
            margin: 10px 0;
            min-height: 16px;
        }
        
        .browse-input {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .browse-input input {
            flex: 1;
            margin: 0;
        }
        .browse-input button {
            margin: 0;
            padding: 8px 12px;
        }
        
        .linked-repos {
            font-size: 11px;
            color: #9cdcfe;
        }
        .linked-repo {
            background: #3a3a3a;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            display: inline-block;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0; 
            background: #252526;
        }
        th, td { 
            border: 1px solid #4a4a4a; 
            padding: 10px; 
            text-align: left; 
            vertical-align: top;
        }
        th { background: #3a3a3a; color: #9cdcfe; }
        tr:nth-child(even) { background: #2a2a2a; }
        
        .status-exists { color: #4caf50; font-weight: bold; }
        .status-missing { color: #f44336; font-weight: bold; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .loading { color: #d7ba7d; font-style: italic; }
        
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; color: #9cdcfe; font-weight: bold; }
        
        .add-form {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .repo-details { 
            background: #1a1a1a; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
            border-left: 3px solid #569cd6;
        }
        
        .link-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        /* Tab System */
        .tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a2a2a;
            border-bottom: 1px solid #4a4a4a;
            padding: 0 20px;
        }
        .tab-navigation {
            display: flex;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #9cdcfe;
            font-weight: 500;
        }
        .tab:hover {
            background: #2a2a2a;
        }
        .tab.active {
            border-bottom-color: #569cd6;
            color: #569cd6;
            background: #2a2a2a;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Header Banner Animation */
        .header-banner {
            text-align: center;
            margin-top: 16px;
            margin-bottom: 16px;
            animation: bannerFadeIn 1.5s ease-out forwards;
            opacity: 0;
            position: relative;
            height: 120px; /* Fixed height to prevent layout shifts */
        }
        
        .header-banner img {
            max-width: 100%;
            height: auto;
            max-height: 120px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: opacity 1.5s ease-in-out;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
        }
        
        .header-banner img.active {
            opacity: 1;
        }
        
        @keyframes bannerFadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }
        
        /* Delayed animation for content after banner */
        .delayed-content {
            animation: contentFadeIn 0.8s ease-out 0.6s forwards;
            opacity: 0;
        }
        
        @keyframes contentFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* SafeTensor Inspector Styles */
        .inspector-header {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            border: 1px solid #4a4a4a;
        }
        .inspector-shortcuts {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .shortcut-btn {
            background: #3a3a3a;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .shortcut-btn:hover {
            background: #4a4a4a;
        }
        .inspector-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .inspector-settings {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .inspector-settings label {
            color: #9cdcfe;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #inspectorCurrentPath {
            font-style: italic;
            color: #888;
            margin-bottom: 10px;
        }
        #inspectorLoadingIndicator {
            margin-left: 10px;
            color: #d7ba7d;
            display: none;
        }
        
        /* Inspector table styles */
        .inspector-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }
        .inspector-table th,
        .inspector-table td {
            border: 1px solid #4a4a4a;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        .inspector-table th {
            background: #2a2a2a;
            cursor: pointer;
            color: #9cdcfe;
        }
        .inspector-table tr:nth-child(even) {
            background-color: #252526;
        }
        .inspector-table tr:hover {
            background: #37373d;
        }
        .inspector-table td a {
            color: #569cd6;
            text-decoration: none;
        }
        .inspector-table td a:hover {
            text-decoration: underline;
        }
        .icon {
            margin-right: 8px;
            font-size: 1.2em;
        }
        .metadata-details {
            font-size: 0.9em;
            color: #b0b0b0;
            margin-top: 8px;
        }
        .metadata-details strong {
            color: #9cdcfe;
        }
        .key-parameters {
            background: #1a1a1a;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            border-left: 3px solid #569cd6;
        }
        .key-parameters .param {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            font-size: 12px;
        }
        .key-parameters .param-name {
            color: #9cdcfe;
            font-weight: bold;
        }
        .key-parameters .param-value {
            color: #d7ba7d;
        }
        .full-headers {
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
            background: #252526;
            padding: 8px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #3a3a3a;
            font-family: Consolas, "Courier New", monospace;
            font-size: 12px;
            margin-top: 4px;
        }
        .full-headers.show {
            display: block;
        }
        .tensor-keys {
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
            background: #252526;
            padding: 8px;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #3a3a3a;
            font-family: Consolas, "Courier New", monospace;
            font-size: 12px;
            margin-top: 4px;
        }
        .tensor-keys.show {
            display: block;
        }
        .headers-label {
            display: none;
        }
        .headers-label.show {
            display: inline;
        }
        .tensor-keys-label {
            display: none;
        }
        .tensor-keys-label.show {
            display: inline;
        }
        .error-message {
            color: #f48771;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #2a2a2a;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        .modal h3 {
            margin-top: 0;
            color: #569cd6;
        }
        .modal .form-group {
            margin: 15px 0;
        }
        .modal .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #9cdcfe;
            font-weight: bold;
        }
        .modal .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        kbd {
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
            color: #d4d4d4;
        }
        
        /* Clickable paths */
        .clickable-path {
            cursor: pointer;
            color: #569cd6;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .clickable-path:hover {
            color: #9cdcfe;
            text-decoration: underline;
        }
        
        /* Path browser styles */
        .browse-btn {
            background: #4a4a4a;
            color: #d4d4d4;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 10px;
        }
        
        .browse-btn:hover {
            background: #5a5a5a;
        }
        
        .path-browser-modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .path-browser-content {
            background-color: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #4a4a4a;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .path-browser-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a4a4a;
        }
        
        .path-browser-current {
            background: #1a1a1a;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            flex: 1;
            margin-right: 10px;
            border: 1px solid #555;
        }
        
        .path-browser-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            background: #1a1a1a;
        }
        
        .path-browser-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
        }
        
        .path-browser-item:hover {
            background: #3a3a3a;
        }
        
        .path-browser-item.directory {
            color: #9cdcfe;
        }
        
        .path-browser-item.file {
            color: #d4d4d4;
        }
        
        .path-browser-icon {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .path-browser-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #4a4a4a;
        }

        /* SafeTensor Inspector folder links */
        #fileTable .name-cell a {
            color: #d4d4d4 !important;
            text-decoration: none;
            font-weight: bold;
            text-decoration: underline;
        }

        #fileTable .name-cell a:hover {
            color: #ffffff !important;
            text-decoration: underline;
        }

        /* Screenshot thumbnail styles */
        .screenshot-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }

        .screenshot-thumbnail {
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            max-width: 200px;
            height: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .screenshot-thumbnail:hover {
            border-color: #569cd6;
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(86, 156, 214, 0.3);
        }

        .screenshot-caption {
            text-align: center;
            font-size: 12px;
            color: #b0b0b0;
            margin-top: 8px;
            font-style: italic;
        }

        /* Lightbox styles */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .lightbox-close:hover {
            color: #569cd6;
        }

        .feature-showcase {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #569cd6;
        }

        .feature-showcase h3 {
            color: #569cd6;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-icon {
            font-size: 1.5em;
        }

        /* Quick Access Compact Box Style */
        
        .quick-access-container {
            background: #2a2a2a;
            border: 1px solid #4a4a4a;
            border-radius: 4px;
            padding: 5px;
            margin: 10px 0;
        }

        .quick-access-section {
            margin-bottom: 15px;
        }

        .quick-access-section:last-child {
            margin-bottom: 0;
        }

        .quick-access-label {
            color: #9cdcfe;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .quick-access-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-access-box {
            background: #4caf50;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 80px;
            text-align: center;
        }

        .quick-access-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            filter: brightness(1.1);
        }


        .quick-access-box.repository {            
            background: #2d5a2d;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
            color: white;
            font-weight: 500;
        }

        .quick-access-box.installation {
            background: #2d5a2d;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
            color: white;
            font-weight: 500;
        }

        .quick-access-box.repository:nth-child(2n) {
            background: #2d5a2d;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
            color: white;
            font-weight: 500;
        }

        .quick-access-box.installation:nth-child(2n) {
            background: #2d5a2d;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
            color: white;
            font-weight: 500;
        }

        /* System Actions in Tab Bar */
        .tab-system-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tab-system-actions button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-system-actions button.success {
            background: #4caf50;
            color: white;
        }

        .tab-system-actions button.success:hover {
            background: #45a049;
        }

        .tab-system-actions button:not(.success) {
            background: #569cd6;
            color: white;
        }

        .tab-system-actions button:not(.success):hover {
            background: #4a8bc2;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab-navigation">
                <div class="tab active" onclick="switchTab('manager')">Model Manager</div>
                <div class="tab" onclick="switchTab('inspector')">SafeTensor Inspector</div>
                <div class="tab" onclick="switchTab('instructions')">Instructions</div>
            </div>
            <div class="tab-system-actions">
                <button onclick="checkAllRepositoryChanges()" class="success">Check Repository Changes</button>
                <button onclick="updateAllLinkStatus()" class="success">Update Link Status</button>
                <button onclick="exportConfig()">Export Config</button>
            </div>
        </div>
        
        <!-- Model Manager Tab -->
        <div id="manager-tab" class="tab-content active">
            <!-- Header Banner -->
            <div class="header-banner">
                <img src="assets/banner00_1200x.png" alt="ComfyUI Model Manager" class="active" id="banner0" />
                <img src="assets/banner01_1200x.png" alt="ComfyUI Model Manager" id="banner1" />
                <img src="assets/banner02_1200x.png" alt="ComfyUI Model Manager" id="banner2" />
                <img src="assets/banner03_1200x.png" alt="ComfyUI Model Manager" id="banner3" />
                <img src="assets/banner04_1200x.png" alt="ComfyUI Model Manager" id="banner4" />
                <img src="assets/banner05_1200x.png" alt="ComfyUI Model Manager" id="banner5" />
                <img src="assets/banner06_1200x.png" alt="ComfyUI Model Manager" id="banner6" />
                <img src="assets/banner07_1200x.png" alt="ComfyUI Model Manager" id="banner7" />
            </div>
            
            
            <!-- Status Message Area -->
            <div id="statusMessage" class="status-area delayed-content" style="margin: 10px 0;"></div>
            
            <!-- Repositories Section -->
            <div class="section delayed-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">Model Repositories</h2>
                    <button onclick="openAddRepositoryModal()" class="success">Add Repository</button>
                </div>
                <p style="color: #b0b0b0; font-style: italic; margin-bottom: 15px;">
                    Repository paths should point directly to your model storage location (e.g., /mnt/storage/ai/models)
                </p>
                <div id="repositories" class="loading">Loading repositories...</div>
            </div>
            
            <!-- ComfyUI Installations with Integrated Link Management -->
            <div class="section delayed-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">ComfyUI Installations & Link Management</h2>
                    <button onclick="openAddInstallationModal()" class="success">Add Installation</button>
                </div>
                <p style="color: #b0b0b0; font-style: italic; margin-bottom: 15px;">
                    Installation paths should point to your ComfyUI root directory (e.g., /home/user/ComfyUI) - the system will automatically manage the /models subfolder
                </p>
                <div id="installations-with-links" class="loading">Loading installations...</div>
            </div>
            

        </div>
        
        <!-- SafeTensor Inspector Tab -->
        <div id="inspector-tab" class="tab-content">
            <h1>Safetensors Inspector 🔎</h1>
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <div id="currentPathDisplay">Current Path: /</div>
                <button onclick="openPathBrowser()" class="browse-btn">Browse...</button>
            </div>
            
            <!-- Quick Access Shortcuts -->
            <div id="inspectorShortcuts" class="quick-access-container">
                <h3 style="margin: 0 0 15px 0; color: #569cd6; font-size: 16px;">Quick Access</h3>
                <div class="quick-access-section">
                    <span class="quick-access-label">Resources:</span>
                    <div id="resourceShortcuts" class="quick-access-grid"></div>
                </div>
                <div class="quick-access-section">
                    <span class="quick-access-label">Installations:</span>
                    <div id="installationShortcuts" class="quick-access-grid"></div>
                </div>
            </div>
            
            <div id="controls">
                <button id="analyzeAllBtn">Analyze All Visible Safetensors</button>
                <div id="settings">
                    <label>
                        <input type="checkbox" id="showHeaders"> Show Headers
                    </label>
                    <label>
                        <input type="checkbox" id="showTensorKeys"> Show Tensor Keys
                    </label>
                </div>
                <div id="loadingIndicator">Loading...</div>
            </div>
            <table id="fileTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">Name & Metadata</th>
                        <th onclick="sortTable(1)">Type</th>
                        <th onclick="sortTable(2)">Size (MB)</th>
                        <th onclick="sortTable(3)">Modified</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- Instructions Tab -->
        <div id="instructions-tab" class="tab-content">
            <div style="max-width: 1200px; margin: 0 auto;">
                <h1 style="text-align: center; color: #569cd6; margin-bottom: 30px;">📖 ComfyUI Model Manager Guide</h1>
                
                <!-- Introduction Section -->
                <div class="section">
                    <h2>🚀 Welcome to ComfyUI Model Manager</h2>
                    <p style="font-size: 18px; line-height: 1.7; color: #d4d4d4; text-align: center; margin-bottom: 30px;">
                        A powerful tool designed to <strong>eliminate model file duplication</strong> across multiple ComfyUI installations 
                        while providing comprehensive model analysis and management capabilities.
                    </p>
                    
                    <div class="screenshot-gallery">
                        <div style="text-align: center;">
                            <img src="assets/screenshots/Overview_ModelManager_Tab.png" 
                                 alt="Model Manager Overview" 
                                 class="screenshot-thumbnail"
                                 onclick="openLightbox(this.src, 'Model Manager Overview - Main interface showing repositories, installations, and link management')">
                            <div class="screenshot-caption">Model Manager Overview</div>
                        </div>
                        <div style="text-align: center;">
                            <img src="assets/screenshots/Overview_SafetensorInspector_Tab.png" 
                                 alt="SafeTensor Inspector Overview" 
                                 class="screenshot-thumbnail"
                                 onclick="openLightbox(this.src, 'SafeTensor Inspector - Browse and analyze model files with detailed metadata')">
                            <div class="screenshot-caption">SafeTensor Inspector Overview</div>
                        </div>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50; margin: 25px 0;">
                        <h3 style="color: #4caf50; margin-top: 0;">🎯 Key Benefits</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>✅ <strong>Eliminate Duplication:</strong> One set of files → Multiple installations</div>
                            <div>🔗 <strong>Smart Linking:</strong> Automatic symbolic link management</div>
                            <div>📊 <strong>Model Analysis:</strong> Deep SafeTensor metadata inspection</div>
                            <div>🗂️ <strong>Easy Navigation:</strong> Quick access to all your model locations</div>
                        </div>
                    </div>
                </div>

                <!-- Core Concepts -->
                <div class="section">
                    <h2>🧠 Core Concepts</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin: 25px 0;">
                        <div class="feature-showcase">
                            <h3><span class="feature-icon">📚</span> Repositories</h3>
                            <p><strong>What:</strong> Your centralized model storage locations</p>
                            <p><strong>Example:</strong> <code>/mnt/storage/ai/models</code></p>
                            <p><strong>Contains:</strong> Your actual model files (.safetensors, .ckpt, etc.)</p>
                            <p style="color: #4caf50; font-style: italic;">💡 Think of these as your master model libraries</p>
                        </div>
                        
                        <div class="feature-showcase" style="border-left-color: #9cdcfe;">
                            <h3><span class="feature-icon">🖥️</span> Installations</h3>
                            <p><strong>What:</strong> Your ComfyUI installations</p>
                            <p><strong>Example:</strong> <code>/home/user/ComfyUI</code></p>
                            <p><strong>Gets:</strong> Symbolic links to repository files</p>
                            <p style="color: #9cdcfe; font-style: italic;">💡 Each installation can access shared models without copying</p>
                        </div>
                    </div>
                </div>

                <!-- Repository Management -->
                <div class="section">
                    <h2>📚 Repository Management</h2>
                    <p style="color: #d4d4d4; margin-bottom: 20px;">
                        Repositories are your central model storage locations. The tool tracks file counts, 
                        monitors changes, and provides easy navigation to browse your model collections.
                    </p>
                    
                    <div class="screenshot-gallery">
                        <div style="text-align: center;">
                            <img src="assets/screenshots/Closeup_ModelManager_repositories.png" 
                                 alt="Repository Management Interface" 
                                 class="screenshot-thumbnail"
                                 onclick="openLightbox(this.src, 'Repository Management - Add, configure, and monitor your centralized model storage locations')">
                            <div class="screenshot-caption">Repository Management Interface</div>
                        </div>
                    </div>

                    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #569cd6;">Repository Features:</h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>File Count Tracking:</strong> Monitor the number of models in each repository</li>
                            <li><strong>Change Detection:</strong> Get notified when new models are added</li>
                            <li><strong>Quick Navigation:</strong> Click any path to browse in SafeTensor Inspector</li>
                            <li><strong>Flexible Organization:</strong> Support for custom folder structures</li>
                        </ul>
                    </div>
                </div>

                <!-- Installation & Link Management -->
                <div class="section">
                    <h2>🔗 Installation & Link Management</h2>
                    <p style="color: #d4d4d4; margin-bottom: 20px;">
                        Link repositories to your ComfyUI installations to share models without duplication. 
                        The system automatically manages symbolic links and folder mappings.
                    </p>
                    
                    <div class="screenshot-gallery">
                        <div style="text-align: center;">
                            <img src="assets/screenshots/Closeup_ComfyUIInstallations_and_LinkManagement.png" 
                                 alt="Installation and Link Management" 
                                 class="screenshot-thumbnail"
                                 onclick="openLightbox(this.src, 'Installation Management - Configure ComfyUI installations and manage symbolic links to repositories')">
                            <div class="screenshot-caption">Installation & Link Management</div>
                        </div>
                    </div>

                    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="color: #9cdcfe;">Link Management Features:</h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Automatic Linking:</strong> One-click repository-to-installation linking</li>
                            <li><strong>Status Monitoring:</strong> Real-time link health and status checking</li>
                            <li><strong>Easy Recreation:</strong> Rebuild links when files are moved or changed</li>
                            <li><strong>Selective Linking:</strong> Choose which repositories each installation can access</li>
                        </ul>
                    </div>
                </div>

                <!-- SafeTensor Inspector -->
                <div class="section">
                    <h2>🔍 SafeTensor Inspector</h2>
                    <p style="color: #d4d4d4; margin-bottom: 20px;">
                        The integrated SafeTensor Inspector provides powerful model analysis capabilities with 
                        quick access shortcuts and detailed metadata extraction.
                    </p>
                    
                    <div class="screenshot-gallery">
                        <div style="text-align: center;">
                            <img src="assets/screenshots/Closeup_Safetensor_QuickAccess.png" 
                                 alt="SafeTensor Quick Access" 
                                 class="screenshot-thumbnail"
                                 onclick="openLightbox(this.src, 'Quick Access Shortcuts - Instantly navigate to any repository or installation')">
                            <div class="screenshot-caption">Quick Access Shortcuts</div>
                        </div>
                        <div style="text-align: center;">
                            <img src="assets/screenshots/Closeup_Safetensor_Metedata.png" 
                                 alt="SafeTensor Metadata Analysis" 
                                 class="screenshot-thumbnail"
                                 onclick="openLightbox(this.src, 'Metadata Analysis - Detailed SafeTensor file inspection with key parameters and tensor information')">
                            <div class="screenshot-caption">Detailed Metadata Analysis</div>
                        </div>
                    </div>

                    <div class="feature-showcase">
                        <h3><span class="feature-icon">⚡</span> Quick Access Shortcuts</h3>
                        <p>Instantly jump to any repository or installation with one click. No more manual navigation!</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Resource Shortcuts:</strong> Direct access to all your model repositories</li>
                            <li><strong>Installation Shortcuts:</strong> Quick navigation to ComfyUI model folders</li>
                            <li><strong>Smart Defaults:</strong> Automatically loads your first repository when opening</li>
                        </ul>
                    </div>

                    <div class="feature-showcase">
                        <h3><span class="feature-icon">📊</span> Advanced Metadata Analysis</h3>
                        <p>Extract and analyze comprehensive information from SafeTensor files:</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div>🔑 <strong>Key Parameters:</strong> Base model, steps, precision</div>
                            <div>📋 <strong>Full Headers:</strong> Complete metadata inspection</div>
                            <div>🗂️ <strong>Tensor Keys:</strong> Detailed tensor structure</div>
                            <div>⚙️ <strong>Batch Analysis:</strong> Process multiple files at once</div>
                        </div>
                    </div>
                </div>

                <!-- Step-by-Step Setup -->
                <div class="section">
                    <h2>🚀 Getting Started - 3 Simple Steps</h2>
                    
                    <div style="counter-reset: step-counter;">
                        <div style="counter-increment: step-counter; display: flex; align-items: flex-start; margin: 25px 0; padding: 20px; background: #2a2a2a; border-radius: 12px; border-left: 4px solid #569cd6;">
                            <div style="background: #569cd6; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-weight: bold; flex-shrink: 0; font-size: 18px;">1</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 15px 0; color: #569cd6;">📚 Add Your Model Repositories</h4>
                                <p style="margin: 0 0 15px 0; font-size: 16px;">Set up your central model storage locations - these are where your actual model files live.</p>
                                
                                <div style="text-align: center; margin: 20px 0;">
                                    <img src="assets/screenshots/Closeup_AddRepository.png" 
                                         alt="Add Repository Dialog" 
                                         class="screenshot-thumbnail"
                                         onclick="openLightbox(this.src, 'Step 1: Add Repository - Configure your central model storage locations')"
                                         style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                    <div class="screenshot-caption">Add Repository Dialog</div>
                                </div>
                                
                                <div style="background: #1a1a1a; padding: 15px; border-radius: 6px; font-family: monospace; margin: 15px 0; border: 1px solid #4a4a4a;">
                                    <div style="color: #4caf50; font-weight: bold; margin-bottom: 8px;">✅ Repository Example:</div>
                                    <div style="color: #d4d4d4;"><strong>Path:</strong> /mnt/nvme/ai/models</div>
                                    <div style="color: #888; margin-top: 8px;">Contains: checkpoints/, loras/, vae/, embeddings/</div>
                                </div>
                                
                                <div style="background: #1e3a1e; padding: 12px; border-radius: 6px; border-left: 3px solid #4caf50; margin: 15px 0;">
                                    <strong style="color: #4caf50;">💡 Key Point:</strong> 
                                    <span style="color: #d4d4d4;">Point to your <em>model storage directory</em>, NOT ComfyUI's models folder</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="counter-increment: step-counter; display: flex; align-items: flex-start; margin: 25px 0; padding: 20px; background: #2a2a2a; border-radius: 12px; border-left: 4px solid #9cdcfe;">
                            <div style="background: #9cdcfe; color: black; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-weight: bold; flex-shrink: 0; font-size: 18px;">2</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 15px 0; color: #9cdcfe;">🖥️ Add Your ComfyUI Installations</h4>
                                <p style="margin: 0 0 15px 0; font-size: 16px;">Register each ComfyUI installation that should access your shared models.</p>
                                
                                <div style="text-align: center; margin: 20px 0;">
                                    <img src="assets/screenshots/Closeup_AddInstallation.png" 
                                         alt="Add Installation Dialog" 
                                         class="screenshot-thumbnail"
                                         onclick="openLightbox(this.src, 'Step 2: Add Installation - Register your ComfyUI installations')"
                                         style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                    <div class="screenshot-caption">Add Installation Dialog</div>
                                </div>
                                
                                <div style="background: #1a1a1a; padding: 15px; border-radius: 6px; font-family: monospace; margin: 15px 0; border: 1px solid #4a4a4a;">
                                    <div style="color: #9cdcfe; font-weight: bold; margin-bottom: 8px;">✅ Installation Example:</div>
                                    <div style="color: #d4d4d4;"><strong>Path:</strong> /home/daniel/ComfyUI</div>
                                    <div style="color: #888; margin-top: 8px;">Tool manages: /home/daniel/ComfyUI/models/</div>
                                </div>
                                
                                <div style="background: #1e2f3a; padding: 12px; border-radius: 6px; border-left: 3px solid #9cdcfe; margin: 15px 0;">
                                    <strong style="color: #9cdcfe;">💡 Key Point:</strong> 
                                    <span style="color: #d4d4d4;">Point to ComfyUI <em>root directory</em> - the tool automatically handles the models subfolder</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="counter-increment: step-counter; display: flex; align-items: flex-start; margin: 25px 0; padding: 20px; background: #2a2a2a; border-radius: 12px; border-left: 4px solid #dcdcaa;">
                            <div style="background: #dcdcaa; color: black; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-weight: bold; flex-shrink: 0; font-size: 18px;">3</div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 15px 0; color: #dcdcaa;">🔗 Link Repositories to Installations</h4>
                                <p style="margin: 0 0 15px 0; font-size: 16px;">Connect your repositories to installations - this creates the symbolic links that share your models.</p>
                                
                                <div style="text-align: center; margin: 20px 0;">
                                    <img src="assets/screenshots/Closeup_LinkRepoInstall.png" 
                                         alt="Link Repository to Installation" 
                                         class="screenshot-thumbnail"
                                         onclick="openLightbox(this.src, 'Step 3: Link Repository to Installation - Create symbolic links to share models')"
                                         style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                    <div class="screenshot-caption">Link Repository to Installation</div>
                                </div>
                                
                                <div style="background: #1a1a1a; padding: 15px; border-radius: 6px; margin: 15px 0; border: 1px solid #4a4a4a;">
                                    <div style="color: #dcdcaa; font-weight: bold; margin-bottom: 8px;">🔗 What Happens:</div>
                                    <div style="color: #d4d4d4; line-height: 1.6;">
                                        • Repository folders → ComfyUI model folders<br>
                                        • Automatic symbolic link creation<br>
                                        • Status monitoring and health checks<br>
                                        • Easy recreation if links break
                                    </div>
                                </div>
                                
                                <div style="background: #3a2e1a; padding: 12px; border-radius: 6px; border-left: 3px solid #dcdcaa; margin: 15px 0;">
                                    <strong style="color: #dcdcaa;">💡 Key Point:</strong> 
                                    <span style="color: #d4d4d4;">You can link <em>multiple repositories</em> to each installation as needed</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="counter-increment: step-counter; display: flex; align-items: flex-start; margin: 25px 0; padding: 20px; background: #2a2a2a; border-radius: 12px; border-left: 4px solid #4caf50;">
                            <div style="background: #4caf50; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-weight: bold; flex-shrink: 0; font-size: 18px;">✓</div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #4caf50;">Explore and Analyze Your Models</h4>
                                <p style="margin: 0 0 10px 0;">Use the SafeTensor Inspector to browse and analyze your model files with detailed metadata.</p>
                                <div style="background: #1a1a1a; padding: 12px; border-radius: 4px; margin: 10px 0;">
                                    <strong>Features:</strong> Quick access shortcuts, metadata analysis, batch processing, tensor inspection
                                </div>
                                <p style="margin: 0; color: #4caf50; font-style: italic;">🎉 Your models are now shared without duplication!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Automatic Folder Mapping -->
                <div class="section">
                    <h2>🗂️ Automatic Folder Mapping</h2>
                    <p style="color: #d4d4d4;">The tool automatically maps repository folders to ComfyUI model folders:</p>
                    
                    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <table style="width: 100%; background: transparent; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #2a2a2a;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #4a4a4a;">Repository Folder</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #4a4a4a;">→</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #4a4a4a;">ComfyUI Folder</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>checkpoints/</code></td><td style="text-align: center; padding: 8px; border: 1px solid #3a3a3a;">→</td><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>models/checkpoints/</code></td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>loras/</code></td><td style="text-align: center; padding: 8px; border: 1px solid #3a3a3a;">→</td><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>models/loras/</code></td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>vae/</code></td><td style="text-align: center; padding: 8px; border: 1px solid #3a3a3a;">→</td><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>models/vae/</code></td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>embeddings/</code></td><td style="text-align: center; padding: 8px; border: 1px solid #3a3a3a;">→</td><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>models/embeddings/</code></td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>controlnet/</code></td><td style="text-align: center; padding: 8px; border: 1px solid #3a3a3a;">→</td><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>models/controlnet/</code></td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>custom_folder/</code></td><td style="text-align: center; padding: 8px; border: 1px solid #3a3a3a;">→</td><td style="padding: 8px; border: 1px solid #3a3a3a;"><code>models/custom_folder/</code></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pro Tips -->
                <div class="section">
                    <h2>💡 Pro Tips & Best Practices</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <h4 style="color: #4caf50; margin-top: 0;">✅ Best Practices</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                <li>Organize repositories by category (e.g., "SDXL Models", "LoRA Collection")</li>
                                <li>Use descriptive names for repositories and installations</li>
                                <li>Regularly use "Check Changes" to monitor new models</li>
                                <li>Click paths to browse them in SafeTensor Inspector</li>
                                <li>Use "Recreate Links" after moving files within repositories</li>
                            </ul>
                        </div>
                        
                        <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #f44336;">
                            <h4 style="color: #f44336; margin-top: 0;">⚠️ Important Notes</h4>
                            <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                <li>Repository paths point to model storage (not ComfyUI models folder)</li>
                                <li>Installation paths point to ComfyUI root directory</li>
                                <li>Repositories and installations must be on the same filesystem</li>
                                <li>Always backup configurations before major changes</li>
                                <li>Use absolute paths for better reliability</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Technical Details -->
                <div class="section">
                    <h2>⚙️ Technical Details</h2>
                    
                    <div class="feature-showcase">
                        <h3><span class="feature-icon">🔗</span> How Symbolic Linking Works</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                            <div>
                                <h4 style="color: #f44336;">❌ Traditional Approach (Wasteful)</h4>
                                <div style="font-family: monospace; background: #2d1a1a; padding: 15px; border-radius: 4px; font-size: 12px; line-height: 1.6;">
Repository: /storage/models/model.safetensors (2GB)<br>
ComfyUI1: /user/ComfyUI1/models/model.safetensors (2GB copy)<br>
ComfyUI2: /user/ComfyUI2/models/model.safetensors (2GB copy)<br>
<span style="color: #f44336;"><strong>Total: 6GB used for one model!</strong></span>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: #4caf50;">✅ Our Approach (Efficient)</h4>
                                <div style="font-family: monospace; background: #1a2d1a; padding: 15px; border-radius: 4px; font-size: 12px; line-height: 1.6;">
Repository: /storage/models/model.safetensors (2GB)<br>
ComfyUI1: /user/ComfyUI1/models/model.safetensors → <span style="color: #4caf50;">symlink</span><br>
ComfyUI2: /user/ComfyUI2/models/model.safetensors → <span style="color: #4caf50;">symlink</span><br>
<span style="color: #4caf50;"><strong>Total: 2GB used for one model!</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Repository Modal -->
    <div id="addRepositoryModal" class="modal">
        <div class="modal-content">
            <h3>Add Repository</h3>
            <form id="addRepositoryForm">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="repoName" required placeholder="e.g., Main Models, SDXL Collection">
                </div>
                <div class="form-group">
                    <label>Path:</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="repoPath" required placeholder="/mnt/nvme0n1p1/ai/resources" style="margin: 0; flex: 1;">
                        <button type="button" onclick="openPathBrowser('repoPath')" class="browse-btn">Browse</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="repoDescription" placeholder="Optional description">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('addRepositoryModal')">Cancel</button>
                    <button type="submit" class="success">Add Repository</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Repository Modal -->
    <div id="editRepositoryModal" class="modal">
        <div class="modal-content">
            <h3>Edit Repository</h3>
            <form id="editRepositoryForm">
                <input type="hidden" id="editRepoId">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="editRepoName" required>
                </div>
                <div class="form-group">
                    <label>Path:</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="editRepoPath" required style="margin: 0; flex: 1;">
                        <button type="button" onclick="openPathBrowser('editRepoPath')" class="browse-btn">Browse</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="editRepoDescription" placeholder="Optional description">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('editRepositoryModal')">Cancel</button>
                    <button type="submit" class="success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Installation Modal -->
    <div id="addInstallationModal" class="modal">
        <div class="modal-content">
            <h3>Add Installation</h3>
            <form id="addInstallationForm">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="installName" required placeholder="e.g., ComfyUI Main, ComfyUI Test">
                </div>
                <div class="form-group">
                    <label>Path (to ComfyUI root directory):</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="installPath" required placeholder="/home/daniel/ai/comfy1/ComfyUI" style="margin: 0; flex: 1;">
                        <button type="button" onclick="openPathBrowser('installPath')" class="browse-btn">Browse</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="installDescription" placeholder="Optional description">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('addInstallationModal')">Cancel</button>
                    <button type="submit" class="success">Add Installation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Installation Modal -->
    <div id="editInstallationModal" class="modal">
        <div class="modal-content">
            <h3>Edit Installation</h3>
            <form id="editInstallationForm">
                <input type="hidden" id="editInstallId">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="editInstallName" required>
                </div>
                <div class="form-group">
                    <label>Path (to ComfyUI root directory):</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="editInstallPath" required style="margin: 0; flex: 1;">
                        <button type="button" onclick="openPathBrowser('editInstallPath')" class="browse-btn">Browse</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="editInstallDescription" placeholder="Optional description">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('editInstallationModal')">Cancel</button>
                    <button type="submit" class="success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="color: #f44336; margin-bottom: 15px;">Confirm Action</h3>
            <div id="confirmationMessage" style="margin-bottom: 20px; font-size: 16px; line-height: 1.4;"></div>
            <div class="form-actions" style="justify-content: center;">
                <button id="confirmYes" class="danger" style="margin-right: 10px;">
                    <span style="text-decoration: underline;">Y</span>es, Delete
                </button>
                <button id="confirmNo" style="margin-left: 10px;">
                    <span style="text-decoration: underline;">N</span>o, Cancel
                </button>
            </div>
            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #888;">
                Press <kbd>Y</kbd> to confirm or <kbd>N</kbd> to cancel
            </div>
        </div>
    </div>

    <!-- Path Browser Modal -->
    <div id="pathBrowserModal" class="path-browser-modal">
        <div class="path-browser-content">
            <div class="path-browser-header">
                <h3 style="margin: 0; color: #569cd6;">Browse Folders</h3>
                <button onclick="closePathBrowser()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">✕</button>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <label style="margin-right: 10px; color: #9cdcfe; font-weight: bold;">Current Path:</label>
                    <div id="pathBrowserCurrent" class="path-browser-current">/</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="browseToParent()" class="browse-btn">.. (Parent)</button>
                    <button onclick="browseToHome()" class="browse-btn">Home</button>
                    <button onclick="browseToRoot()" class="browse-btn">Root</button>
                </div>
            </div>
            
            <div id="pathBrowserList" class="path-browser-list">
                <div style="padding: 20px; text-align: center; color: #888;">Loading...</div>
            </div>
            
            <div class="path-browser-actions">
                <button onclick="selectCurrentPath()" class="success">Select This Folder</button>
                <button onclick="closePathBrowser()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Lightbox for Screenshots -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
        <div id="lightbox-caption" style="text-align: center; color: #d4d4d4; margin-top: 15px; padding: 0 20px; font-size: 16px; line-height: 1.4;"></div>
    </div>

    <script>
        let repositories = [];
        let installations = [];
        let links = {};
        let initialLoadComplete = false;
        let allDataLoaded = false;

        // Load data on page load
        window.addEventListener('load', function() {
            loadRepositories();
            loadInstallations();
            loadLinks();
            updateAllLinkStatus();
            initializeInspector();
            initializeBannerRotation();

            // Mark initial load as complete after animations finish
            setTimeout(() => {
                initialLoadComplete = true;
            }, 2000); // After the delayed content animation completes

            // Set up confirmation modal buttons
            document.getElementById('confirmYes').addEventListener('click', function() {
                if (confirmationCallback) {
                    confirmationCallback();
                    hideConfirmation();
                }
            });

            document.getElementById('confirmNo').addEventListener('click', function() {
                hideConfirmation();
            });

            // Keyboard shortcuts for confirmation modal
            document.addEventListener('keydown', function(event) {
                const confirmationModal = document.getElementById('confirmationModal');
                if (confirmationModal.style.display === 'block') {
                    if (event.key.toLowerCase() === 'y') {
                        event.preventDefault();
                        document.getElementById('confirmYes').click();
                    } else if (event.key.toLowerCase() === 'n' || event.key === 'Escape') {
                        event.preventDefault();
                        document.getElementById('confirmNo').click();
                    }
                }
            });
        });

        // Automatic path checking
        async function checkAllPaths() {
            try {
                await apiCall('/api/refresh_paths', 'POST');
            } catch (error) {
                console.error('Error checking paths:', error);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(`${tabName}-tab`);
            targetTab.classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Remove animation delays for instant tab switching (only after initial load)
            if (tabName === 'manager' && initialLoadComplete) {
                // Remove delayed animation classes to make content appear instantly
                document.querySelectorAll('#manager-tab .delayed-content').forEach(element => {
                    element.style.animation = 'none';
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                });
            }
            
            // Update shortcuts when switching to inspector
            if (tabName === 'inspector') {
                updateInspectorShortcuts();
            }
        }

        // Handle path clicks to navigate to SafeTensor Inspector
        function navigateToPath(path) {
            // Switch to inspector tab
            switchTab('inspector');
            // Navigate to the path
            navigateInspectorTo(path);
        }

        // Status message helper
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        }

        // SafeTensor Inspector functionality (Complete Standalone Implementation)
        let currentPath = '';
        const tableBody = document.querySelector("#fileTable tbody");
        const currentPathDisplay = document.getElementById('currentPathDisplay');
        const analyzeAllBtn = document.getElementById('analyzeAllBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const showHeadersCheckbox = document.getElementById('showHeaders');
        const showTensorKeysCheckbox = document.getElementById('showTensorKeys');
        let activeAnalyses = 0;

        // Update shortcuts when switching to inspector
        async function updateInspectorShortcuts() {
            try {
                // Fetch repositories and installations
                const [reposResponse, installsResponse] = await Promise.all([
                    fetch('/api/repositories'),
                    fetch('/api/installations')
                ]);
                
                const repositories = await reposResponse.json();
                const installations = await installsResponse.json();
                
                // Create resource shortcuts
                const resourceShortcuts = document.getElementById('resourceShortcuts');
                resourceShortcuts.innerHTML = '';
                
                repositories.forEach((repo, index) => {
                    const box = document.createElement('button');
                    box.textContent = repo.name || `Repo ${repo.id}`;
                    box.className = 'quick-access-box repository';
                    box.onclick = () => navigateInspectorTo(repo.path);
                    resourceShortcuts.appendChild(box);
                });
                
                // Create installation shortcuts
                const installationShortcuts = document.getElementById('installationShortcuts');
                installationShortcuts.innerHTML = '';
                
                installations.forEach((install, index) => {
                    const box = document.createElement('button');
                    box.textContent = install.name || `Install ${install.id}`;
                    box.className = 'quick-access-box installation';
                    box.onclick = () => navigateInspectorTo(install.path + '/models');
                    installationShortcuts.appendChild(box);
                });
                
                // Set default path to first repository if available and current path is empty
                if (repositories.length > 0 && (!currentPath || currentPath === '')) {
                    fetchAndRenderDirectory(repositories[0].path);
                }
                
            } catch (error) {
                console.error('Error updating inspector shortcuts:', error);
            }
        }

        function initializeInspector() {
            // Set up event listeners for inspector
            updateLoadingIndicator();
            
            showHeadersCheckbox.addEventListener('change', function() {
                const headerElements = document.querySelectorAll('.full-headers');
                const headerLabels = document.querySelectorAll('.headers-label');
                headerElements.forEach(element => {
                    if (this.checked) {
                        element.classList.add('show');
                    } else {
                        element.classList.remove('show');
                    }
                });
                headerLabels.forEach(element => {
                    if (this.checked) {
                        element.classList.add('show');
                    } else {
                        element.classList.remove('show');
                    }
                });
            });

            showTensorKeysCheckbox.addEventListener('change', function() {
                const tensorKeyElements = document.querySelectorAll('.tensor-keys');
                const tensorKeyLabels = document.querySelectorAll('.tensor-keys-label');
                tensorKeyElements.forEach(element => {
                    if (this.checked) {
                        element.classList.add('show');
                    } else {
                        element.classList.remove('show');
                    }
                });
                tensorKeyLabels.forEach(element => {
                    if (this.checked) {
                        element.classList.add('show');
                    } else {
                        element.classList.remove('show');
                    }
                });
            });

            tableBody.addEventListener('click', function(event) {
                const target = event.target;
                if (target.tagName === 'A' && target.dataset.path !== undefined) {
                    event.preventDefault();
                    fetchAndRenderDirectory(target.dataset.path);
                } else if (target.classList.contains('analyze-btn')) {
                    event.preventDefault();
                    const row = target.closest('tr');
                    const filePath = target.dataset.path;
                    const fileName = row.dataset.fileName;
                    analyzeSingleFile(filePath, fileName, row);
                }
            });

            analyzeAllBtn.addEventListener('click', function() {
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const analyzeBtn = row.querySelector('.analyze-btn');
                    if (analyzeBtn && !analyzeBtn.disabled) {
                        const filePath = analyzeBtn.dataset.path;
                        const fileName = row.dataset.fileName;
                        analyzeSingleFile(filePath, fileName, row);
                    }
                });
            });

            // Load shortcuts and set default path
            updateInspectorShortcuts();
        }

        function navigateInspectorTo(path) {
            // Switch to inspector tab if not already there
            switchTab('inspector');
            // Navigate to the path
            fetchAndRenderDirectory(path);
        }

        function updateLoadingIndicator() {
            if (activeAnalyses > 0) {
                loadingIndicator.style.display = 'inline';
                analyzeAllBtn.disabled = true;
            } else {
                loadingIndicator.style.display = 'none';
                analyzeAllBtn.disabled = false;
            }
        }

        function extractKeyParameters(metadata) {
            const keyParams = {
                'ss_base_model_version': null,
                'modelspec.architecture': null,
                'ss_steps': null,
                'ss_mixed_precision': null
            };

            if (metadata && typeof metadata === 'object' && !metadata.error) {
                for (const [key, value] of Object.entries(metadata)) {
                    if (keyParams.hasOwnProperty(key)) {
                        keyParams[key] = value;
                    }
                }
            }

            return keyParams;
        }

        function renderKeyParameters(keyParams) {
            const hasParams = Object.values(keyParams).some(val => val !== null);
            if (!hasParams) return '';

            let html = '<div class="key-parameters">';
            for (const [key, value] of Object.entries(keyParams)) {
                if (value !== null) {
                    html += `<div class="param">
                        <span class="param-name">${key}:</span>
                        <span class="param-value">${value}</span>
                    </div>`;
                }
            }
            html += '</div>';
            return html;
        }

        function renderMetadata(itemData, isUpdate = false) {
            let metadataHtml = '<div class="metadata-details">';
            let hasContent = false;

            // Always render key parameters first if we have header metadata
            if (itemData.header_metadata && !itemData.header_metadata.error) {
                const keyParams = extractKeyParameters(itemData.header_metadata);
                const keyParamsHtml = renderKeyParameters(keyParams);
                if (keyParamsHtml) {
                    metadataHtml += keyParamsHtml;
                    hasContent = true;
                }
            }

            // Render full headers (toggleable with label)
            if (itemData.header_metadata) {
                if (itemData.header_metadata.error) {
                    metadataHtml += `<strong class="error-message">Headers Error:</strong><pre class="error-message">${JSON.stringify(itemData.header_metadata.error, null, 2)}</pre>`;
                } else if (Object.keys(itemData.header_metadata).length > 0) {
                    const showHeadersClass = showHeadersCheckbox.checked ? ' show' : '';
                    const headerLabelClass = showHeadersCheckbox.checked ? ' show' : '';
                    metadataHtml += `<strong class="headers-label${headerLabelClass}">Headers:</strong><pre class="full-headers${showHeadersClass}">` + JSON.stringify(itemData.header_metadata, null, 2) + '</pre>';
                    hasContent = true;
                } else if (isUpdate) {
                    const showHeadersClass = showHeadersCheckbox.checked ? ' show' : '';
                    const headerLabelClass = showHeadersCheckbox.checked ? ' show' : '';
                    metadataHtml += `<strong class="headers-label${headerLabelClass}">Headers:</strong><pre class="full-headers${showHeadersClass}">(No header metadata found)</pre>`;
                }
            }

            // Render tensor keys (toggleable with label)
            if (itemData.tensor_keys) {
                const showTensorKeysClass = showTensorKeysCheckbox.checked ? ' show' : '';
                const tensorKeysLabelClass = showTensorKeysCheckbox.checked ? ' show' : '';
                if (itemData.tensor_keys.length > 0) {
                    metadataHtml += `<strong class="tensor-keys-label${tensorKeysLabelClass}">Tensor Keys:</strong><pre class="tensor-keys${showTensorKeysClass}">` + JSON.stringify(itemData.tensor_keys, null, 2) + '</pre>';
                    hasContent = true;
                } else if (isUpdate) {
                    metadataHtml += `<strong class="tensor-keys-label${tensorKeysLabelClass}">Tensor Keys:</strong><pre class="tensor-keys${showTensorKeysClass}">(No tensor keys found)</pre>`;
                }
            }
            metadataHtml += '</div>';
            return (hasContent || isUpdate) ? metadataHtml : '';
        }

        function fetchAndRenderDirectory(path) {
            currentPath = path;
            const displayPath = path ? (path.startsWith('/') ? path : '/' + path) : '/';
            currentPathDisplay.textContent = `Current Path: ${displayPath}`;
            activeAnalyses++;
            updateLoadingIndicator();

            fetch(`/api/browse?path=${encodeURIComponent(path)}`)
                .then(res => {
                    if (!res.ok) return res.text().then(text => { throw new Error(`Server error: ${res.status} ${text || res.statusText}`) });
                    return res.json();
                })
                .then(data => {
                    tableBody.innerHTML = '';
                    data.forEach(item => {
                        const tr = document.createElement("tr");
                        tr.dataset.filePath = item.path;
                        tr.dataset.fileName = item.name;

                        let nameCellContent;
                        const icon = item.type === 'directory' ? '📁' : '📄';

                        if (item.type === 'directory') {
                            nameCellContent = `<span class="icon">${icon}</span><a href="#" data-path="${item.path}">${item.name}</a>`;
                        } else {
                            nameCellContent = `<span class="icon">${icon}</span>${item.name}`;
                            if (item.name.toLowerCase().endsWith('.safetensors')) {
                                nameCellContent += renderMetadata(item, false);
                            }
                        }

                        const itemTypeDisplay = item.model_type || (item.type === 'file' ? 'File' : 'Folder');
                        const itemSize = item.type === 'file' && typeof item.size_mb === 'number' ? item.size_mb : '-';
                        const itemModified = item.type === 'file' && item.modified ? new Date(item.modified).toLocaleString() : '-';

                        let actionsCellContent = '';
                        if (item.type === 'file' && item.name.toLowerCase().endsWith('.safetensors')) {
                            actionsCellContent = `<button class="analyze-btn" data-path="${item.path}">Analyze</button>`;
                        }

                        tr.innerHTML =
                            `<td class="name-cell">${nameCellContent}</td>
                             <td>${itemTypeDisplay}</td>
                             <td>${itemSize}</td>
                             <td>${itemModified}</td>
                             <td>${actionsCellContent}</td>`;
                        tableBody.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error('Error fetching directory contents:', error);
                    tableBody.innerHTML = `<tr><td colspan="5" class="error-message" style="text-align:center;">Error loading: ${error.message}</td></tr>`;
                })
                .finally(() => {
                    activeAnalyses--;
                    updateLoadingIndicator();
                });
        }

        function analyzeSingleFile(filePath, fileName, rowElement) {
            const analyzeBtn = rowElement.querySelector('.analyze-btn');
            if (analyzeBtn) analyzeBtn.disabled = true;
            activeAnalyses++;
            updateLoadingIndicator();

            fetch(`/api/analyze_file?path=${encodeURIComponent(filePath)}`)
                .then(res => {
                    if (!res.ok) return res.text().then(text => { throw new Error(`Analyze error: ${res.status} ${text || res.statusText}`) });
                    return res.json();
                })
                .then(data => {
                    const nameCell = rowElement.querySelector('.name-cell');
                    const oldDetails = nameCell.querySelector('.metadata-details');
                    if (oldDetails) oldDetails.remove();

                    const icon = '📄';
                    nameCell.innerHTML = `<span class="icon">${icon}</span>${fileName}` + renderMetadata(data, true);

                    if (data.model_type) {
                        const typeCell = rowElement.children[1];
                        typeCell.textContent = data.model_type;
                    }
                })
                .catch(error => {
                    console.error('Error analyzing file:', error);
                    const nameCell = rowElement.querySelector('.name-cell');
                    const errorDiv = `<div class="metadata-details error-message"><strong>Error:</strong><pre>${error.message}</pre></div>`;
                    const oldDetails = nameCell.querySelector('.metadata-details');
                    if (oldDetails) oldDetails.insertAdjacentHTML('afterend', errorDiv);
                    else nameCell.innerHTML += errorDiv;
                })
                .finally(() => {
                    if (analyzeBtn) analyzeBtn.disabled = false;
                    activeAnalyses--;
                    updateLoadingIndicator();
                });
        }

        function sortTable(colIndex) {
            const rows = Array.from(tableBody.querySelectorAll("tr"));
            const isAscending = tableBody.dataset.sortCol === colIndex && tableBody.dataset.sortDir === 'asc';
            const sortDir = isAscending ? 'desc' : 'asc';
            tableBody.dataset.sortCol = colIndex;
            tableBody.dataset.sortDir = sortDir;

            rows.sort((a, b) => {
                let valA = a.children[colIndex]?.textContent || '';
                let valB = b.children[colIndex]?.textContent || '';

                if (colIndex === 0) {
                    const iconA = a.children[colIndex].querySelector('.icon');
                    valA = (iconA ? iconA.nextSibling.textContent : valA.split('\n')[0]).trim();
                    const iconB = b.children[colIndex].querySelector('.icon');
                    valB = (iconB ? iconB.nextSibling.textContent : valB.split('\n')[0]).trim();
                } else if (colIndex === 2) {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) return (numA - numB) * (sortDir === 'asc' ? 1 : -1);
                    if (!isNaN(numA)) return sortDir === 'asc' ? -1 : 1;
                    if (!isNaN(numB)) return sortDir === 'asc' ? 1 : -1;
                }

                const comparison = valA.localeCompare(valB, undefined, { numeric: colIndex !== 0 && colIndex !== 1, sensitivity: 'base' });
                return comparison * (sortDir === 'asc' ? 1 : -1);
            });

            tableBody.innerHTML = "";
            rows.forEach(r => tableBody.appendChild(r));
        }

        // API functions
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load functions
        async function loadRepositories() {
            try {
                repositories = await apiCall('/api/repositories');
                await checkAllPaths(); // Check paths after loading
                await renderRepositories();
            } catch (error) {
                document.getElementById('repositories').innerHTML = `<div class="error">Error loading repositories: ${error.message}</div>`;
            }
        }

        async function loadInstallations() {
            try {
                installations = await apiCall('/api/installations');
                await checkAllPaths(); // Check paths after loading
                await renderInstallations();
            } catch (error) {
                document.getElementById('installations-with-links').innerHTML = `<div class="error">Error loading installations: ${error.message}</div>`;
            }
        }

        async function loadLinks() {
            try {
                links = await apiCall('/api/links');
                // Links are now rendered as part of installations
                await renderInstallations();
            } catch (error) {
                document.getElementById('installations-with-links').innerHTML = `<div class="error">Error loading links: ${error.message}</div>`;
            }
        }

        async function updateAllLinkStatus() {
            try {
                showStatus('Checking link status...', 'loading');
                await apiCall('/api/update_link_status', 'POST');
                await loadInstallations();
                await loadLinks();
                showStatus('Link status updated successfully', 'success');
            } catch (error) {
                showStatus(`Error updating link status: ${error.message}`, 'error');
            }
        }

        // Render functions
        async function renderRepositories() {
            const container = document.getElementById('repositories');
            if (repositories.length === 0) {
                container.innerHTML = '<p>No repositories configured.</p>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th style="width: 15%;">Name</th>
                            <th style="width: 20%;">Path</th>
                            <th style="width: 25%;">Model Folders</th>
                            <th style="width: 12%;">Total Files</th>
                            <th style="width: 12%;">Total Size</th>
                            <th style="width: 8%;">Status</th>
                            <th style="width: 8%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const repo of repositories) {
                const statusClass = repo.exists ? 'status-exists' : 'status-missing';
                const statusText = repo.exists ? 'Exists' : 'Missing';
                
                // Get folder details
                let folderStats = '';
                let totalFiles = 0;
                let totalSize = '';
                
                if (repo.exists) {
                    try {
                        const folderData = await apiCall(`/api/repository_folders?repo_id=${repo.id}`);
                        const folders = folderData.folders;
                        totalFiles = folderData.total_files || 0;
                        totalSize = folderData.total_size_gb ? `${folderData.total_size_gb} GB` : '0 GB';
                        
                        folderStats = '<div class="folder-stats">';
                        
                        // Show standard folders first
                        const standardFolders = folders.filter(f => f.is_standard);
                        const customFolders = folders.filter(f => !f.is_standard);
                        
                        standardFolders.forEach(folder => {
                            const hasFiles = folder.file_count > 0;
                            folderStats += `<div class="folder-stat ${hasFiles ? 'has-files' : ''}">${folder.name}: ${folder.file_count}</div>`;
                        });
                        
                        // Show custom folders with different styling
                        customFolders.forEach(folder => {
                            const hasFiles = folder.file_count > 0;
                            folderStats += `<div class="folder-stat ${hasFiles ? 'has-files' : ''}" style="background: #4a4a2a; border-left: 3px solid #d7ba7d; color: white;">${folder.name}: ${folder.file_count}</div>`;
                        });
                        
                        folderStats += '</div>';
                    } catch (error) {
                        folderStats = '<div class="error">Unable to scan folders</div>';
                        totalFiles = 'Error';
                        totalSize = 'Error';
                    }
                } else {
                    folderStats = '<div class="status-missing">Path not found</div>';
                    totalFiles = '-';
                    totalSize = '-';
                }
                
                html += `
                    <tr>
                        <td><strong>${repo.name}</strong></td>
                        <td><code class="clickable-path" onclick="navigateToPath('${repo.path}')" style="font-size: 12px;" title="Click to browse in SafeTensor Inspector">${repo.path}</code></td>
                        <td>${folderStats}</td>
                        <td style="text-align: center;"><strong>${totalFiles}</strong></td>
                        <td style="text-align: center;"><strong>${totalSize}</strong></td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>
                            <button onclick="checkRepositoryChanges(${repo.id})" style="background: #4caf50; margin-right: 5px; font-size: 11px; padding: 4px 8px;">Check Changes</button>
                            <button onclick="openEditRepositoryModal(${repo.id})" style="font-size: 11px; padding: 4px 8px;">Edit</button>
                            <button onclick="deleteRepository(${repo.id})" class="danger" style="font-size: 11px; padding: 4px 8px;">Delete</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function renderInstallations() {
            const container = document.getElementById('installations-with-links');
            if (installations.length === 0) {
                container.innerHTML = '<p>No ComfyUI installations configured.</p>';
                return;
            }

            let html = '';
            
            for (const install of installations) {
                const statusClass = install.exists ? 'status-exists' : 'status-missing';
                const statusText = install.exists ? 'Exists' : 'Missing';
                
                // Get link summary
                let linkSummary = '';
                try {
                    const summary = await apiCall(`/api/installation_summary?install_id=${install.id}`);
                    const totalLinks = summary.total_links || 0;
                    
                    if (totalLinks > 0) {
                        linkSummary = `<span class="status-exists">${totalLinks} linked files</span>`;
                        const folderBreakdown = [];
                        for (const [folder, data] of Object.entries(summary.folders)) {
                            if (data.linked_count > 0) {
                                folderBreakdown.push(`${folder}: ${data.linked_count}`);
                            }
                        }
                        if (folderBreakdown.length > 0) {
                            linkSummary += `<div class="folder-stats">${folderBreakdown.map(f => `<div class="folder-stat has-files">${f}</div>`).join('')}</div>`;
                        }
                    } else {
                        linkSummary = '<span class="status-missing">No linked models</span>';
                    }
                } catch (error) {
                    linkSummary = '<span class="error">Status unknown</span>';
                }
                
                // Get linked repositories for this installation
                const linkedRepos = links[install.id] || [];
                
                html += `
                    <div class="installation-card" style="border: 1px solid #4a4a4a; border-radius: 8px; padding: 20px; margin: 42px 0; background: #1a1a1a;">
                        <!-- Installation Header -->
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 5px 0; color: #569cd6;">${install.name}</h3>
                                <div style="margin: 5px 0;"><strong>Path:</strong> <code class="clickable-path" onclick="navigateToPath('${install.path}')" style="background: #2a2a2a; padding: 2px 6px; border-radius: 3px;" title="Click to browse in SafeTensor Inspector">${install.path}</code></div>
                                <div style="margin: 5px 0;"><strong>Status:</strong> <span class="${statusClass}">${statusText}</span></div>
                                <div style="margin: 5px 0;"><strong>Linked Models:</strong> ${linkSummary}</div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="openEditInstallationModal(${install.id})" style="margin: 0;">Edit</button>
                                <button onclick="deleteInstallation(${install.id})" class="danger" style="margin: 0;">Delete</button>
                            </div>
                        </div>
                        
                        <!-- Link Management -->
                        <div style="border-top: 1px solid #4a4a4a; padding-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #9cdcfe;">Repository Linking</h4>
                            
                            <!-- Add Repository Link -->
                            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                                <select id="repoSelect${install.id}" style="flex: 1; margin: 0;">
                                    <option value="">Select repository to link...</option>
                                    ${repositories.filter(repo => !linkedRepos.includes(repo.id)).map(repo => 
                                        `<option value="${repo.id}">${repo.name}</option>`
                                    ).join('')}
                                </select>
                                <button onclick="linkRepository(${install.id})" class="success" style="margin: 0; white-space: nowrap;">Add & Link</button>
                            </div>
                            
                            <!-- Linked Repositories -->
                            <div>
                                <strong>Currently Linked:</strong>
                                ${linkedRepos.length === 0 ? '<em style="color: #888;">No repositories linked</em>' : ''}
                                ${linkedRepos.map(repoId => {
                                    const repo = repositories.find(r => r.id === repoId);
                                    return repo ? `
                                        <div style="margin: 8px 0; padding: 10px; background: #2a2a2a; border-radius: 4px; border-left: 3px solid #569cd6;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <strong style="color: #9cdcfe;">${repo.name}</strong>
                                                    <strong style="font-size: 12px; color: #888; margin-top: 2px;">${repo.path}</strong>
                                                </div>
                                                <div style="display: flex; gap: 5px;">
                                                    <button onclick="relinkRepository(${install.id}, ${repo.id})" class="success" style="margin: 0; font-size: 12px; padding: 4px 8px;">Recreate Links</button>
                                                    <button onclick="unlinkRepository(${install.id}, ${repo.id})" class="danger" style="margin: 0; font-size: 12px; padding: 4px 8px;">Remove</button>
                                                </div>
                                            </div>
                                        </div>
                                    ` : '';
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Form handlers
        document.getElementById('addRepositoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('repoName').value,
                path: document.getElementById('repoPath').value,
                description: document.getElementById('repoDescription').value
            };
            
            try {
                await apiCall('/api/repositories', 'POST', data);
                showStatus('Repository added successfully', 'success');
                await loadRepositories();
                await loadInstallations(); // Refresh installations to update link dropdowns
                closeModal('addRepositoryModal');
                this.reset();
            } catch (error) {
                showStatus(`Error adding repository: ${error.message}`, 'error');
            }
        });

        document.getElementById('addInstallationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('installName').value,
                path: document.getElementById('installPath').value,
                description: document.getElementById('installDescription').value
            };
            
            try {
                await apiCall('/api/installations', 'POST', data);
                showStatus('Installation added successfully', 'success');
                await loadInstallations();
                await loadLinks();
                closeModal('addInstallationModal');
                this.reset();
            } catch (error) {
                showStatus(`Error adding installation: ${error.message}`, 'error');
            }
        });

        document.getElementById('editRepositoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editRepoId').value;
            const data = {
                name: document.getElementById('editRepoName').value,
                path: document.getElementById('editRepoPath').value,
                description: document.getElementById('editRepoDescription').value
            };
            
            try {
                await apiCall(`/api/repositories/${id}`, 'PUT', data);
                showStatus('Repository updated successfully', 'success');
                await loadRepositories();
                await loadInstallations(); // Refresh installations to update repository names
                closeModal('editRepositoryModal');
            } catch (error) {
                showStatus(`Error updating repository: ${error.message}`, 'error');
            }
        });

        document.getElementById('editInstallationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('editInstallId').value;
            const data = {
                name: document.getElementById('editInstallName').value,
                path: document.getElementById('editInstallPath').value,
                description: document.getElementById('editInstallDescription').value
            };
            
            try {
                await apiCall(`/api/installations/${id}`, 'PUT', data);
                showStatus('Installation updated successfully', 'success');
                await loadInstallations();
                closeModal('editInstallationModal');
            } catch (error) {
                showStatus(`Error updating installation: ${error.message}`, 'error');
            }
        });

        // Modal functions
        function openAddRepositoryModal() {
            document.getElementById('addRepositoryModal').style.display = 'block';
        }

        function openAddInstallationModal() {
            document.getElementById('addInstallationModal').style.display = 'block';
        }

        function openEditRepositoryModal(id) {
            const repo = repositories.find(r => r.id === id);
            if (repo) {
                document.getElementById('editRepoId').value = repo.id;
                document.getElementById('editRepoName').value = repo.name;
                document.getElementById('editRepoPath').value = repo.path;
                document.getElementById('editRepoDescription').value = repo.description || '';
                document.getElementById('editRepositoryModal').style.display = 'block';
            }
        }

        function openEditInstallationModal(id) {
            const install = installations.find(i => i.id === id);
            if (install) {
                document.getElementById('editInstallId').value = install.id;
                document.getElementById('editInstallName').value = install.name;
                document.getElementById('editInstallPath').value = install.path;
                document.getElementById('editInstallDescription').value = install.description || '';
                document.getElementById('editInstallationModal').style.display = 'block';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Confirmation Modal Functions
        let confirmationCallback = null;

        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmationMessage').innerHTML = message;
            document.getElementById('confirmationModal').style.display = 'block';
            confirmationCallback = onConfirm;
            
            // Focus on the Yes button for keyboard accessibility
            document.getElementById('confirmYes').focus();
        }

        function hideConfirmation() {
            document.getElementById('confirmationModal').style.display = 'none';
            confirmationCallback = null;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // CRUD operations
        async function deleteRepository(id) {
            const repo = repositories.find(r => r.id === id);
            if (!repo) return;
            
            const message = `Are you sure you want to delete the repository <strong>"${repo.name}"</strong>?<br><br>This will remove all its links from ComfyUI installations.`;
            
            showConfirmation(message, async function() {
                try {
                    await apiCall(`/api/repositories/${id}`, 'DELETE');
                    showStatus('Repository deleted', 'success');
                    await loadRepositories();
                    await loadLinks();
                } catch (error) {
                    showStatus(`Error deleting repository: ${error.message}`, 'error');
                }
            });
        }

        async function deleteInstallation(id) {
            const install = installations.find(i => i.id === id);
            if (!install) return;
            
            const message = `Are you sure you want to delete the ComfyUI installation <strong>"${install.name}"</strong>?<br><br>This will remove all repository links associated with this installation.`;
            
            showConfirmation(message, async function() {
                try {
                    await apiCall(`/api/installations/${id}`, 'DELETE');
                    showStatus('Installation deleted', 'success');
                    await loadInstallations();
                    await loadLinks();
                } catch (error) {
                    showStatus(`Error deleting installation: ${error.message}`, 'error');
                }
            });
        }

        // Repository change detection
        async function checkRepositoryChanges(repoId) {
            try {
                showStatus('Checking for changes...', 'loading');
                const result = await apiCall('/api/repository_changes', 'POST', { repo_id: repoId });
                
                if (result.success) {
                    const changes = result.changes;
                    let changeMessages = [];
                    
                    if (changes.new_folders.length > 0) {
                        const newFolderNames = changes.new_folders.map(f => f.name).join(', ');
                        changeMessages.push(`New folders detected: ${newFolderNames}`);
                    }
                    
                    if (changes.removed_folders.length > 0) {
                        const removedFolderNames = changes.removed_folders.map(f => f.name).join(', ');
                        changeMessages.push(`Removed folders: ${removedFolderNames}`);
                    }
                    
                    if (changes.changed_folders.length > 0) {
                        const changedDetails = changes.changed_folders.map(f => 
                            `${f.name} (${f.change > 0 ? '+' : ''}${f.change} files)`
                        ).join(', ');
                        changeMessages.push(`File count changes: ${changedDetails}`);
                    }
                    
                    if (changeMessages.length > 0) {
                        showStatus(`Changes detected: ${changeMessages.join(' | ')}`, 'success');
                        await loadRepositories(); // Refresh the display
                    } else {
                        showStatus('No changes detected in repository folders', 'success');
                    }
                } else {
                    showStatus(`Error checking changes: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error checking repository changes: ${error.message}`, 'error');
            }
        }

        async function checkAllRepositoryChanges() {
            try {
                showStatus('Checking all repositories for changes...', 'loading');
                const result = await apiCall('/api/check_repository_changes', 'POST');
                
                if (result.total_changes > 0) {
                    let changeMessages = [];
                    
                    for (const [repoId, repoData] of Object.entries(result.repositories)) {
                        const changes = repoData.changes;
                        const repoName = repoData.repo_name;
                        
                        if (changes.new_folders.length > 0) {
                            changeMessages.push(`${repoName}: New folders - ${changes.new_folders.map(f => f.name).join(', ')}`);
                        }
                        
                        if (changes.changed_folders.length > 0) {
                            changeMessages.push(`${repoName}: File changes - ${changes.changed_folders.map(f => f.name).join(', ')}`);
                        }
                    }
                    
                    showStatus(`${result.total_changes} changes detected: ${changeMessages.join(' | ')}`, 'success');
                    await loadRepositories(); // Refresh the display
                } else {
                    showStatus('No changes detected in any repositories', 'success');
                }
            } catch (error) {
                showStatus(`Error checking repository changes: ${error.message}`, 'error');
            }
        }

        // Link management
        async function linkRepository(installId) {
            const repoId = parseInt(document.getElementById(`repoSelect${installId}`).value);
            if (!repoId) {
                showStatus('Please select a repository to link', 'error');
                return;
            }
            
            try {
                showStatus('Creating links...', 'loading');
                await apiCall('/api/link', 'POST', { install_id: installId, repo_id: repoId });
                const result = await apiCall('/api/perform_link', 'POST', { install_id: installId, repo_id: repoId });
                
                if (result.success) {
                    const counts = Object.values(result.results).reduce((sum, r) => sum + (r.count || 0), 0);
                    showStatus(`Repository linked successfully! ${counts} files linked.`, 'success');
                } else {
                    showStatus(`Error creating symbolic links: ${result.error}`, 'error');
                }
                
                await loadLinks();
                await loadInstallations();
            } catch (error) {
                showStatus(`Error linking repository: ${error.message}`, 'error');
            }
        }

        async function relinkRepository(installId, repoId) {
            try {
                showStatus('Recreating links...', 'loading');
                const result = await apiCall('/api/perform_link', 'POST', { install_id: installId, repo_id: repoId });
                
                if (result.success) {
                    const counts = Object.values(result.results).reduce((sum, r) => sum + (r.count || 0), 0);
                    showStatus(`Links recreated successfully! ${counts} files linked.`, 'success');
                } else {
                    showStatus(`Error recreating links: ${result.error}`, 'error');
                }
                
                await loadInstallations();
            } catch (error) {
                showStatus(`Error recreating links: ${error.message}`, 'error');
            }
        }

        async function unlinkRepository(installId, repoId) {
            try {
                showStatus('Removing links...', 'loading');
                await apiCall('/api/unlink', 'POST', { install_id: installId, repo_id: repoId });
                const result = await apiCall('/api/perform_unlink', 'POST', { install_id: installId, repo_id: repoId });
                
                if (result.success) {
                    const counts = Object.values(result.results).reduce((sum, r) => sum + (r.count || 0), 0);
                    showStatus(`Repository unlinked successfully! ${counts} symbolic links removed.`, 'success');
                } else {
                    showStatus(`Error removing symbolic links: ${result.error}`, 'error');
                }
                
                await loadLinks();
                await loadInstallations();
            } catch (error) {
                showStatus(`Error unlinking repository: ${error.message}`, 'error');
            }
        }

        // Utility functions
        async function exportConfig() {
            try {
                const config = await apiCall('/api/config');
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'model_manager_config.json';
                a.click();
                URL.revokeObjectURL(url);
                showStatus('Configuration exported', 'success');
            } catch (error) {
                showStatus(`Error exporting config: ${error.message}`, 'error');
            }
        }

        // Banner rotation system
        let currentBannerIndex = 0;
        let bannerRotationInterval;
        const bannerCount = 8;
        const bannerRotationDelay = 15000; // 15 seconds between rotations

        function initializeBannerRotation() {
            // Start automatic rotation after initial page load animation
            setTimeout(() => {
                startBannerRotation();
            }, 5000); // Wait 5 seconds after page load
        }

        function startBannerRotation() {
            bannerRotationInterval = setInterval(() => {
                nextBanner();
            }, bannerRotationDelay);
        }

        function nextBanner() {
            const currentBanner = document.getElementById(`banner${currentBannerIndex}`);
            const nextIndex = (currentBannerIndex + 1) % bannerCount;
            const nextBanner = document.getElementById(`banner${nextIndex}`);

            // Simple fade transition
            currentBanner.classList.remove('active');
            
            // After current banner fades out, show next banner
            setTimeout(() => {
                nextBanner.classList.add('active');
                currentBannerIndex = nextIndex;
            }, 750); // Half of the 1.5s transition time
        }

        // Initialize banner rotation when page loads
        window.addEventListener('load', function() {
            initializeBannerRotation();
        });

        // Lightbox functionality for screenshots
        function openLightbox(imageSrc, caption) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxCaption = document.getElementById('lightbox-caption');
            
            lightboxImg.src = imageSrc;
            lightboxCaption.textContent = caption || '';
            lightbox.style.display = 'flex';
            
            // Prevent body scrolling when lightbox is open
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'none';
            
            // Restore body scrolling
            document.body.style.overflow = 'auto';
        }

        // Close lightbox with escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeLightbox();
            }
        });

        // Path Browser functionality
        let currentBrowserPath = '';
        let browserTargetInputId = null;

        async function openPathBrowser(inputId = null) {
            browserTargetInputId = inputId;
            const modal = document.getElementById('pathBrowserModal');
            modal.style.display = 'flex';
            
            // Start browsing from home directory if no input ID (for inspector)
            if (!inputId) {
                await loadBrowserPath('');
            } else {
                // Start from current input value or home
                const input = document.getElementById(inputId);
                const currentPath = input ? input.value : '';
                await loadBrowserPath(currentPath || '');
            }
        }

        function closePathBrowser() {
            document.getElementById('pathBrowserModal').style.display = 'none';
            browserTargetInputId = null;
        }

        async function loadBrowserPath(path) {
            const pathDisplay = document.getElementById('pathBrowserCurrent');
            const pathList = document.getElementById('pathBrowserList');
            
            // Show loading
            pathList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading...</div>';
            
            try {
                const response = await fetch(`/api/browse?mode=filesystem&path=${encodeURIComponent(path)}`);
                const data = await response.json();
                
                if (data.error) {
                    pathList.innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">Error: ${data.error}</div>`;
                    return;
                }
                
                currentBrowserPath = data.current_path;
                pathDisplay.textContent = currentBrowserPath;
                
                renderBrowserItems(data.items);
            } catch (error) {
                pathList.innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">Failed to load directory</div>`;
            }
        }

        function renderBrowserItems(items) {
            const pathList = document.getElementById('pathBrowserList');
            
            if (items.length === 0) {
                pathList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">This directory is empty</div>';
                return;
            }
            
            const html = items.map(item => {
                const icon = item.is_directory ? '📁' : '📄';
                const className = item.is_directory ? 'directory' : 'file';
                return `
                    <div class="path-browser-item ${className}" onclick="navigateToBrowserPath('${item.path}', ${item.is_directory})">
                        <span class="path-browser-icon">${icon}</span>
                        <span>${item.name}</span>
                    </div>
                `;
            }).join('');
            
            pathList.innerHTML = html;
        }

        async function navigateToBrowserPath(path, isDirectory) {
            if (isDirectory) {
                await loadBrowserPath(path);
            }
        }

        async function browseToParent() {
            if (currentBrowserPath !== '/') {
                const parentPath = currentBrowserPath.split('/').slice(0, -1).join('/') || '/';
                await loadBrowserPath(parentPath);
            }
        }

        async function browseToHome() {
            await loadBrowserPath('');
        }

        async function browseToRoot() {
            await loadBrowserPath('/');
        }

        function selectCurrentPath() {
            if (browserTargetInputId) {
                // Set the path to an input field
                const input = document.getElementById(browserTargetInputId);
                if (input) {
                    input.value = currentBrowserPath;
                }
            } else {
                // Navigate the inspector to this path
                fetchAndRenderDirectory(currentBrowserPath);
            }
            closePathBrowser();
        }
    </script>
</body>
</html>